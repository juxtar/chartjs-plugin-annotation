!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("chart.js")):"function"==typeof define&&define.amd?define(["chart.js"],t):(e=e||self).ChartAnnotationPlugin=t(e.ChartJS)}(this,(function(e){"use strict";e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;const t={drawTime:"afterDatasetsDraw",dblClickSpeed:350,events:[],annotations:[]},n={backgroundColor:"rgba(0,0,0,0.8)",fontFamily:e.defaults.global.defaultFontFamily,fontSize:e.defaults.global.defaultFontSize,fontStyle:"bold",fontColor:"#fff",xPadding:6,yPadding:6,cornerRadius:6,position:"center",xAdjust:0,yAdjust:0,enabled:!1,content:null};function i(e){var t=e.annotation.elements;return Object.keys(t).map((function(e){return t[e]}))}var a=e.helpers;var o={initConfig:function(e){return e=a.configMerge(t,e),a.isArray(e.annotations)&&e.annotations.forEach((function(e){e.label=a.configMerge(n,e.label)})),e},elements:i,callEach:function(e,t){e.forEach((function(e){(t?e[t]:e)()}))},noop:function(){},objectId:function(){return Math.random().toString(36).substr(2,6)},isValid:function(e){return null!=e&&("number"==typeof e?isFinite(e):!!e)},decorate:function(e,t,n){e["$"+t]||(e[t]?(e["$"+t]=e[t].bind(e),e[t]=function(){var i=[e["$"+t]].concat(Array.prototype.slice.call(arguments));return n.apply(e,i)}):e[t]=function(){var t=[void 0].concat(Array.prototype.slice.call(arguments));return n.apply(e,t)})},adjustScaleRange:function(e){var t,n,a,o,l,r=(t=e.id,n=i(e.chart),a=e.min,o=e.max,{min:(l=n.filter((function(e){return!!e._model.ranges[t]})).map((function(e){return e._model.ranges[t]}))).map((function(e){return Number(e.min)})).reduce((function(e,t){return isFinite(t)&&!isNaN(t)&&t<e?t:e}),a),max:l.map((function(e){return Number(e.max)})).reduce((function(e,t){return isFinite(t)&&!isNaN(t)&&t>e?t:e}),o)});void 0===e.options.ticks.min&&void 0===e.options.ticks.suggestedMin&&(e.min=r.min),void 0===e.options.ticks.max&&void 0===e.options.ticks.suggestedMax&&(e.max=r.max),e.handleTickRangeOptions&&e.handleTickRangeOptions()},getNearestItems:function(e,t){var n=Number.POSITIVE_INFINITY;return e.filter((function(e){return e.inRange(t.x,t.y)})).reduce((function(e,i){var o=i.getCenterPoint(),l=a.distanceBetweenPoints(t,o);return l<n?(e=[i],n=l):l===n&&e.push(i),e}),[]).sort((function(e,t){var n=e.getArea(),i=t.getArea();return n>i||n<i?n-i:e._index-t._index})).slice(0,1)[0]},getEventHandlerName:function(e){return"on"+e[0].toUpperCase()+e.substring(1)},createMouseEvent:function(e,t){try{return new MouseEvent(e,t)}catch(a){try{var n=document.createEvent("MouseEvent");return n.initMouseEvent(e,t.canBubble,t.cancelable,t.view,t.detail,t.screenX,t.screenY,t.clientX,t.clientY,t.ctrlKey,t.altKey,t.shiftKey,t.metaKey,t.button,t.relatedTarget),n}catch(n){var i=document.createEvent("Event");return i.initEvent(e,t.canBubble,t.cancelable),i}}}},l=e.helpers;function r(e){var t=!1,n=e.filter((function(e){switch(e){case"mouseenter":case"mouseover":case"mouseout":case"mouseleave":return t=!0,!1;default:return!0}}));return t&&-1===n.indexOf("mousemove")&&n.push("mousemove"),n}var s={dispatcher:function(e){var t=this.annotation,n=o.elements(this),i=l.getRelativePosition(e,this.chart),a=o.getNearestItems(n,i),s=r(t.options.events),c=t.options.dblClickSpeed,u=[],d=o.getEventHandlerName(e.type),h=(a||{}).options;if("mousemove"===e.type&&(a&&!a.hovering?["mouseenter","mouseover"].forEach((function(t){var n=o.getEventHandlerName(t),i=o.createMouseEvent(t,e);a.hovering=!0,"function"==typeof h[n]&&u.push([h[n],i,a])})):a||n.forEach((function(t){if(t.hovering){t.hovering=!1;var n=t.options;["mouseout","mouseleave"].forEach((function(i){var a=o.getEventHandlerName(i),l=o.createMouseEvent(i,e);"function"==typeof n[a]&&u.push([n[a],l,t])}))}}))),a&&s.indexOf("dblclick")>-1&&"function"==typeof h.onDblclick){if("click"===e.type&&"function"==typeof h.onClick)return clearTimeout(a.clickTimeout),a.clickTimeout=setTimeout((function(){delete a.clickTimeout,h.onClick.call(a,e)}),c),e.stopImmediatePropagation(),void e.preventDefault();"dblclick"===e.type&&a.clickTimeout&&(clearTimeout(a.clickTimeout),delete a.clickTimeout)}a&&"function"==typeof h[d]&&0===u.length&&u.push([h[d],e,a]),u.length>0&&(e.stopImmediatePropagation(),e.preventDefault(),u.forEach((function(e){e[0].call(e[2],e[1])})))},collapseHoverEvents:r},c=e.helpers,u=e.Element.extend({initialize:function(){this.hidden=!1,this.hovering=!1,this._model=c.clone(this._model)||{},this.setDataLimits()},destroy:function(){},setDataLimits:function(){},configure:function(){},inRange:function(){},getCenterPoint:function(){},getWidth:function(){},getHeight:function(){},getArea:function(){},draw:function(){}}),d=u.extend({setDataLimits:function(){var e=this._model,t=this.options,n=this.chartInstance,i=n.scales[t.xScaleID],a=n.scales[t.yScaleID],l=n.chartArea;if(e.ranges={},l){var r=0,s=0;i&&(r=o.isValid(t.xMin)?t.xMin:i.getValueForPixel(l.left),s=o.isValid(t.xMax)?t.xMax:i.getValueForPixel(l.right),e.ranges[t.xScaleID]={min:Math.min(r,s),max:Math.max(r,s)}),a&&(r=o.isValid(t.yMin)?t.yMin:a.getValueForPixel(l.bottom),s=o.isValid(t.yMax)?t.yMax:a.getValueForPixel(l.top),e.ranges[t.yScaleID]={min:Math.min(r,s),max:Math.max(r,s)})}},configure:function(){var e=this._model,t=this.options,n=this.chartInstance,i=n.scales[t.xScaleID],a=n.scales[t.yScaleID],l=n.chartArea;e.clip={x1:l.left,x2:l.right,y1:l.top,y2:l.bottom};var r,s,c=l.left,u=l.top,d=l.right,h=l.bottom;i&&(r=o.isValid(t.xMin)?i.getPixelForValue(t.xMin):l.left,s=o.isValid(t.xMax)?i.getPixelForValue(t.xMax):l.right,c=Math.min(r,s),d=Math.max(r,s)),a&&(r=o.isValid(t.yMin)?a.getPixelForValue(t.yMin):l.bottom,s=o.isValid(t.yMax)?a.getPixelForValue(t.yMax):l.top,u=Math.min(r,s),h=Math.max(r,s)),e.left=c,e.top=u,e.right=d,e.bottom=h,e.borderColor=t.borderColor,e.borderWidth=t.borderWidth,e.backgroundColor=t.backgroundColor},inRange:function(e,t){var n=this._model;return n&&e>=n.left&&e<=n.right&&t>=n.top&&t<=n.bottom},getCenterPoint:function(){var e=this._model;return{x:(e.right+e.left)/2,y:(e.bottom+e.top)/2}},getWidth:function(){var e=this._model;return Math.abs(e.right-e.left)},getHeight:function(){var e=this._model;return Math.abs(e.bottom-e.top)},getArea:function(){return this.getWidth()*this.getHeight()},draw:function(){var e=this._view,t=this.chartInstance.chart.ctx;t.save(),t.beginPath(),t.rect(e.clip.x1,e.clip.y1,e.clip.x2-e.clip.x1,e.clip.y2-e.clip.y1),t.clip(),t.lineWidth=e.borderWidth,t.strokeStyle=e.borderColor,t.fillStyle=e.backgroundColor;var n=e.right-e.left,i=e.bottom-e.top;t.fillRect(e.left,e.top,n,i),t.strokeRect(e.left,e.top,n,i),t.restore()}}),h=e.helpers;function f(e){var t=(e.x2-e.x1)/(e.y2-e.y1),n=e.x1||0;this.m=t,this.b=n,this.getX=function(i){return t*(i-e.y1)+n},this.getY=function(i){return(i-n)/t+e.y1},this.intersects=function(e,t,n){n=n||.001;var i=this.getY(e),a=this.getX(t);return(!isFinite(i)||Math.abs(t-i)<n)&&(!isFinite(a)||Math.abs(e-a)<n)}}var b=u.extend({setDataLimits:function(){var e=this._model,t=this.options;e.ranges={},e.ranges[t.scaleID]={min:t.value,max:t.endValue||t.value}},configure:function(){var e,t,n=this._model,i=this.options,a=this.chartInstance,l=a.chart.ctx,r=a.scales[i.scaleID];if(r&&(e=o.isValid(i.value)?r.getPixelForValue(i.value,i.value.index):NaN,t=o.isValid(i.endValue)?r.getPixelForValue(i.endValue,i.value.index):e),!isNaN(e)){var s=a.chartArea;n.clip={x1:s.left,x2:s.right,y1:s.top,y2:s.bottom},"horizontal"===this.options.mode?(n.x1=s.left,n.x2=s.right,n.y1=e,n.y2=t):(n.y1=s.top,n.y2=s.bottom,n.x1=e,n.x2=t),n.line=new f(n),n.mode=i.mode,n.labelBackgroundColor=i.label.backgroundColor,n.labelFontFamily=i.label.fontFamily,n.labelFontSize=i.label.fontSize,n.labelFontStyle=i.label.fontStyle,n.labelFontColor=i.label.fontColor,n.labelXPadding=i.label.xPadding,n.labelYPadding=i.label.yPadding,n.labelCornerRadius=i.label.cornerRadius,n.labelPosition=i.label.position,n.labelXAdjust=i.label.xAdjust,n.labelYAdjust=i.label.yAdjust,n.labelEnabled=i.label.enabled,n.labelContent=i.label.content,l.font=h.fontString(n.labelFontSize,n.labelFontStyle,n.labelFontFamily);var c=l.measureText(n.labelContent).width,u=n.labelFontSize;if(n.labelHeight=u+2*n.labelYPadding,n.labelContent&&h.isArray(n.labelContent)){var d=n.labelContent.slice(0).sort((function(e,t){return t.length-e.length}))[0];c=l.measureText(d).width,n.labelHeight=u*n.labelContent.length+2*n.labelYPadding,n.labelHeight+=n.labelYPadding*(n.labelContent.length-1)}var b=function(e,t,n,i,a){var o=e.line,l={},r=0,s=0;switch(!0){case"vertical"===e.mode&&"top"===e.labelPosition:s=a+e.labelYAdjust,r=t/2+e.labelXAdjust,l.y=e.y1+s,l.x=(isFinite(o.m)?o.getX(l.y):e.x1)-r;break;case"vertical"===e.mode&&"bottom"===e.labelPosition:s=n+a+e.labelYAdjust,r=t/2+e.labelXAdjust,l.y=e.y2-s,l.x=(isFinite(o.m)?o.getX(l.y):e.x1)-r;break;case"horizontal"===e.mode&&"left"===e.labelPosition:r=i+e.labelXAdjust,s=-n/2+e.labelYAdjust,l.x=e.x1+r,l.y=o.getY(l.x)+s;break;case"horizontal"===e.mode&&"right"===e.labelPosition:r=t+i+e.labelXAdjust,s=-n/2+e.labelYAdjust,l.x=e.x2-r,l.y=o.getY(l.x)+s;break;default:l.x=(e.x1+e.x2-t)/2+e.labelXAdjust,l.y=(e.y1+e.y2-n)/2+e.labelYAdjust}return l}(n,c,u,n.labelXPadding,n.labelYPadding);n.labelX=b.x-n.labelXPadding,n.labelY=b.y-n.labelYPadding,n.labelWidth=c+2*n.labelXPadding,n.borderColor=i.borderColor,n.borderWidth=i.borderWidth,n.borderDash=i.borderDash||[],n.borderDashOffset=i.borderDashOffset||0}},inRange:function(e,t){var n=this._model;return n.line&&n.line.intersects(e,t,this.getHeight())||n.labelEnabled&&n.labelContent&&e>=n.labelX&&e<=n.labelX+n.labelWidth&&t>=n.labelY&&t<=n.labelY+n.labelHeight},getCenterPoint:function(){return{x:(this._model.x2+this._model.x1)/2,y:(this._model.y2+this._model.y1)/2}},getWidth:function(){return Math.abs(this._model.right-this._model.left)},getHeight:function(){return this._model.borderWidth||1},getArea:function(){return Math.sqrt(Math.pow(this.getWidth(),2)+Math.pow(this.getHeight(),2))},draw:function(){var e=this._view,t=this.chartInstance.chart.ctx;if(e.clip){if(t.save(),t.beginPath(),t.rect(e.clip.x1,e.clip.y1,e.clip.x2-e.clip.x1,e.clip.y2-e.clip.y1),t.clip(),t.lineWidth=e.borderWidth,t.strokeStyle=e.borderColor,t.setLineDash&&t.setLineDash(e.borderDash),t.lineDashOffset=e.borderDashOffset,t.beginPath(),t.moveTo(e.x1,e.y1),t.lineTo(e.x2,e.y2),t.stroke(),e.labelEnabled&&e.labelContent)if(t.beginPath(),t.rect(e.clip.x1,e.clip.y1,e.clip.x2-e.clip.x1,e.clip.y2-e.clip.y1),t.clip(),t.fillStyle=e.labelBackgroundColor,h.drawRoundedRectangle(t,e.labelX,e.labelY,e.labelWidth,e.labelHeight,e.labelCornerRadius),t.fill(),t.font=h.fontString(e.labelFontSize,e.labelFontStyle,e.labelFontFamily),t.fillStyle=e.labelFontColor,t.textAlign="center",e.labelContent&&h.isArray(e.labelContent))for(var n=e.labelY+e.labelYPadding,i=0;i<e.labelContent.length;i++)t.textBaseline="top",t.fillText(e.labelContent[i],e.labelX+e.labelWidth/2,n),n+=e.labelFontSize+e.labelYPadding;else t.textBaseline="middle",t.fillText(e.labelContent,e.labelX+e.labelWidth/2,e.labelY+e.labelHeight/2);t.restore()}}}),g=45*Math.PI/180,m=Math.sin(g);const p={line:b,box:d,marker:u.extend({setDataLimits:function(){var e=this._model,t=this.options;this.chartInstance.chartArea;e.ranges={},e.ranges[t.xScaleID]={min:t.xValue,max:t.xValue},e.ranges[t.yScaleID]={min:t.yValue,max:t.yValue}},configure:function(){var e,t,n=this._model,i=this.options,a=this.chartInstance,l=a.scales[i.xScaleID],r=a.scales[i.yScaleID],s=a.chartArea;if(l&&(e=o.isValid(i.xValue)?l.getPixelForValue(i.xValue,i.xValue.index):NaN),r&&(t=o.isValid(i.yValue)?r.getPixelForValue(i.yValue,i.yValue.index):NaN),!isNaN(e)&&!isNaN(t)){n.clip={x1:s.left-i.size,x2:s.right+i.size,y1:s.top-i.size,y2:s.bottom+i.size};var c=i.size/2;n.x1=n.x2=e,n.y1=n.y2=t,n.left=e-c,n.top=t-c,n.right=e+c,n.bottom=t+c,n.borderColor=i.borderColor,n.borderWidth=i.borderWidth,n.backgroundColor=i.backgroundColor}},inRange:function(e,t){var n=this._model;return n&&e>=n.left&&e<=n.right&&t>=n.top&&t<=n.bottom},getCenterPoint:function(){var e=this._model;return{x:(e.right+e.left)/2,y:(e.bottom+e.top)/2}},getWidth:function(){var e=this._model;return Math.abs(e.right-e.left)},getHeight:function(){var e=this._model;return Math.abs(e.bottom-e.top)},getArea:function(){return this.getWidth()*this.getHeight()},draw:function(){var e=this._view,t=this.options,n=this.chartInstance.chart.ctx,i=t.size/2;n.save(),n.beginPath(),n.rect(e.clip.x1,e.clip.y1,e.clip.x2-e.clip.x1,e.clip.y2-e.clip.y1),n.clip(),n.lineWidth=e.borderWidth,n.strokeStyle=e.borderColor,n.fillStyle=e.backgroundColor;var a=.5/m*(e.x1+e.y1)-i,o=.5/m*(e.y1-e.x1)-i;n.rotate(g),n.fillRect(a,o,t.size,t.size),n.strokeRect(a,o,t.size,t.size),n.rotate(-g),n.restore()}})};var x=e.helpers;function y(e){o.decorate(e,"afterDataLimits",(function(e,t){e&&e(t),o.adjustScaleRange(t)}))}function v(e){return function(t,n){var i=t.annotation.options.drawTime;o.elements(t).filter((function(t){return e===(t.options.drawTime||i)})).forEach((function(e){e.configure(),e.transition(n).draw()}))}}function C(e){var t=e.plugins;return(t&&t.annotation?t.annotation:null)||e.annotation||{}}var P={id:"annotation",beforeInit:function(e){var t=e.options,n=e.annotation={elements:{},options:o.initConfig(C(t)),onDestroy:[],firstRun:!0,supported:!1};e.ensureScalesHaveIDs(),t.scales&&(n.supported=!0,x.each(t.scales.xAxes,y),x.each(t.scales.yAxes,y))},beforeUpdate:function(e){var t=e.annotation;if(t.supported){t.firstRun?t.firstRun=!1:t.options=o.initConfig(C(e.options));var n=[];t.options.annotations.forEach((function(i){var a=i.id||o.objectId();if(!t.elements[a]&&p[i.type]){var l=new(0,p[i.type])({id:a,options:i,chartInstance:e});l.initialize(),t.elements[a]=l,i.id=a,n.push(a)}else t.elements[a]&&n.push(a)})),Object.keys(t.elements).forEach((function(e){-1===n.indexOf(e)&&(t.elements[e].destroy(),delete t.elements[e])}))}},beforeDatasetsDraw:v("beforeDatasetsDraw"),afterDatasetsDraw:v("afterDatasetsDraw"),afterDraw:v("afterDraw"),afterInit:function(e){var t=e.annotation.options.events;if(x.isArray(t)&&t.length>0){var n=e.chart.canvas,i=s.dispatcher.bind(e);s.collapseHoverEvents(t).forEach((function(t){x.addEvent(n,t,i),e.annotation.onDestroy.push((function(){x.removeEvent(n,t,i)}))}))}},destroy:function(e){if(e&&e.annotation)for(var t=e.annotation.onDestroy;t.length>0;)t.pop()()}};return e.pluginService.register(P),P}));
